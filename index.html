<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.2 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li class="current"><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1></h1><h2><a class="anchor" id="overview">
Overview</a></h2>
<p>The BrowserPlus ServiceAPI allows you to write native plugins that can be loaded by BrowserPlus. These plugins (or "services") are primarily designed to expose a scriptable interface to Javascript running in a web browser.</p>
<p>A service consists of a directory which contains a single required file, manifest.json, which is json text that points to the shared library (.dll or .so) that implements the service. The manifest.json also includes other information, such as localized end-user visible strings identifying at a high level what the service does, and any explicit permissions that should be requested from the user. Here is a sample manifest file for a service that displays desktop notifications:</p>
<div class="fragment"><pre class="fragment">{
  <span class="stringliteral">&quot;type&quot;</span>: <span class="stringliteral">&quot;standalone&quot;</span>,
  <span class="stringliteral">&quot;ServiceLibrary&quot;</span>: <span class="stringliteral">&quot;notify.dll&quot;</span>,
  <span class="stringliteral">&quot;strings&quot;</span>: {
    <span class="stringliteral">&quot;en&quot;</span>: {
      <span class="stringliteral">&quot;title&quot;</span>: <span class="stringliteral">&quot;Notify&quot;</span>,
      <span class="stringliteral">&quot;summary&quot;</span>: <span class="stringliteral">&quot;A service to deliver desktop notifications.&quot;</span>
    }
  },
  <span class="stringliteral">&quot;permissions&quot;</span>: [
    <span class="stringliteral">&quot;DisplayNotifications&quot;</span>  
  ]
}
</pre></div><p>The other entities in the service's directory are the dynamic library itself, and whatever else the service author wishes to include.</p>
<h2><a class="anchor" id="overview">
Overview</a></h2>
<p>As this API allows for native services to be authored, the first question that may arise is how do we support multiple platforms? At the time services are published, they may be marked platform specific, or platform independent. To support multiple platforms, the only requirement is that the same service with the same version exports the same API. It is up to the service author whether and how they wish to share code between implementations.</p>
<p>Finally, because services may be written in high level languages (Ruby and Python are two languages supported today), it is possible to implement a service as Ruby on one platform, and native code on another.</p>
<h2><a class="anchor" id="fileOverview">
File Overview</a></h2>
<p>The ServiceAPI is a header only SDK. No libraries are required.</p>
<ul>
<li><a class="el" href="bperror_8h.html">bperror.h</a> -- Error values which go both ways across the Service/BrowserPlus boundary.</li>
<li><a class="el" href="bptypes_8h.html">bptypes.h</a> -- Structures which allow data to be represented that may be introspected. The data format defined herein is how information is transmitted across the service/BrowserPlus boundary.</li>
<li><a class="el" href="bpdefinition_8h.html">bpdefinition.h</a> -- Definitions of structures which are used to defining the interface of a service.</li>
<li><a class="el" href="bpcfunctions_8h.html">bpcfunctions.h</a> -- Functions exposed by BrowserPlus which may be invoked by a service.</li>
<li><a class="el" href="bppfunctions_8h.html">bppfunctions.h</a> -- Functions implemented by a service which will be invoked by BrowserPlus.</li>
</ul>
<p>These C header files compose the lowest level "ServiceAPI", however it is worth noting that several libraries and frameworks exist which simplify the process of writing a service. These frameworks can be found on github at <a href="http://github.com/browserplus">http://github.com/browserplus</a></p>
<h2><a class="anchor" id="designReqs">
Design Requirements</a></h2>
<p>The design of the BrowserPlus ServiceAPI was motivated by the following goals:</p>
<ol type="1">
<li>It must be possible to dynamically map a services interface into a high level laguage (usually JavaScript).</li>
<li>non-responsive services should not render the whole system non-responsive.</li>
<li>The entire interface should be asynchronous to prevent unresponsiveness.</li>
<li>Complex return values from services must be supported.</li>
<li>The data representation must allow serialization into different formats, and must be bindable into different languages.</li>
<li>The API should not preclude cross platform services.</li>
<li>The API should be flexible enough to allow for interpreter services to be authored, which allows for the authoring of other services in high level languages.</li>
<li>The API should be designed with versioning and binary compatibility in mind. A version of a service may be in production for a Long Time.</li>
</ol>
<h2><a class="anchor" id="serviceTypes">
Service Types</a></h2>
<p>There are three different types of services, this type is specified in the service manifest (manifest.json)</p>
<ol type="1">
<li>'standalone' - Binary services implemented as a shared library</li>
<li>'provider' - Binary services implemented as a shared library that can run 'dependent' services</li>
<li>'dependent' - Services (not necessarily binary) that require the existence of another service to function.</li>
</ol>
<h2><a class="anchor" id="symbolSpelunking">
Symbol Spelunking</a></h2>
<p>Exactly one symbol is the contract between services and BrowserPlusCore. This symbol is "BPPGetEntryPoints", a symbol that returns a function which takes no arguments and returns a structure. The first member of that structure is a 32bit integer which holds the service api version against which the service was written. All function pointers from service to BrowserPlus or vice versa are passed in structures, which means that no import libraries are required, and only one symbol must be exported from a service.</p>
<h2><a class="anchor" id="loadingProcedure">
Service Loading Procedure</a></h2>
<p>BPP* functions are provided by the service and are called by BPCore. The service loading procedure is thus:</p>
<ol type="1">
<li>The dynamic library is loaded.</li>
<li>The "BPPGetEntryPoint" symbol is extracted and called to get a BPPFunctionTable pointer. This table contains the version of the service API to which the service was written.</li>
<li>if the service hasn't been loaded since it was installed, BPInstall() will be invoked.</li>
<li>BPPInitialize() is called which passes control to the service to attain a description of the supported functions and deliver a function table which may be used to call back into BrowserPlus.</li>
<li>BPPAllocate may be invoked any number of times.</li>
<li>BPPInvokePtr may be called from the "main" thread on different allocated instances of the service.</li>
<li>BPPDestroy will be called once per allocated instance.</li>
<li>BPPShutdown will be called after the last BPPDestroy call.</li>
<li>if the service is going to be removed after unload, BPUninstall() will be invoked.</li>
<li>the service library will be unloaded from memory</li>
<li>the hosting process will shut down.</li>
</ol>
<h2><a class="anchor" id="memoryManagement">
Memory Management</a></h2>
<p>Anything that the service allocates, the service must free. Anything that BrowserPlus allocates, BrowserPlus must free. All pointers passed into a function traveling either direction are valid only for the duration of the function, the caller may free immediately after the function returns.</p>
<h2><a class="anchor" id="threadModel">
Threading Model</a></h2>
<p>The threading model for services is intended to minimize complexity and maximize flexibility, leaving as much up to the service author as possible. All functions invoked by BrowserPlus on the service will be invoked from the "main" or "primordeal" thread of execution. On platforms where pertinent, there will be a OS provided "runloop" running on this thread (a Cocoa runloop or a Win32 message pump).</p>
<p>The service may allocate and run as many threads as it likes, and may call into BrowserPlus on any of them.</p>
<h2><a class="anchor" id="serviceDescription">
Defining your service</a></h2>
<p>After loading a service, BrowserPlus will want to know what functions the service supports and what arguments those functions accept, and the name and version of the service, etc. All of this information is conveyed through C structures documented in <a class="el" href="bpdefinition_8h.html">bpdefinition.h</a>.</p>
<h2><a class="anchor" id="dataBinding">
Data Binding</a></h2>
<p>A main purpose of services is usually to get data back to the execution environment that invoked the service. Before crossing the service &lt;-&gt; BrowserPlus boundary, data must be mapped into an intermediate format. Our solution to this problem is very similar to that of NPAPI. <a class="el" href="bptypes_8h.html">bptypes.h</a> defines a set of structures capable of holding all of the different data types we support.</p>
<p>Working with the structures directly is supported, but leads to complex code. As mentioned above, there are ongoing efforts to develop service frameworks to simplify the authoring of native services, especially in the area of data binding. All pertinent projects are available on github: <a href="http://github.com/browserplus">http://github.com/browserplus</a></p>
<h2><a class="anchor" id="paths">
File System Paths</a></h2>
<p>Paths in the system are passed around as operating system native paths. That is, on unix, all paths are forward slash delimited, UTF8. On windows, paths are windows style UTF16.</p>
<p>In <a class="el" href="bptypes_8h.html">bptypes.h</a>, the pertinent type is BPNativePath where you'll see that the type is either a wchar_t * or a char * -- depending on the platform.</p>
<h2><a class="anchor" id="providerServices">
Provider Services</a></h2>
<p>A "provider" service is one that can be required by a "dependent" service. This mechanism minimally affects the authors of "standalone" services while making it possible to enable services written in high level languages. Finally, while the design motivation for this mechanism was to support interpreter services, it's conceivable that it could be applied to other use cases.</p>
<p>A provider service will be loaded any time a dependent service that requires it is loaded. At the time BPPInitialize() is called on the provider service, the path to the dependent service will be provided, and also any content in the manifest.json of the dependent service under the 'arguments' key will be parsed and passed into the provider. This mechanism allows the dependent service to provide arguments to the provider, and leaves the decision of the structure and content of those arguments up to the implementor of the provider service. </p>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.2 </small></address>
</body>
</html>
